<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./style.css">
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <title>N·ªôp H·ªì S∆° 7.8</title>
</head>
<body>
  <div class="container">
    <div class="wrapper">
      <div class="header">
        <h1 class="brand">LI√äN DANH HANTA</h1>
      </div>
      <div class="subscribe">
        <h2>H·ªí S∆† 7.8A & 7.8</h2>
        <p class="subtitle">Enter your details for instant access üëá</p>
        <form enctype="multipart/form-data" id="myForm">
          <div><input type="text" name="Company" id="Company" placeholder="Nh√† th·∫ßu n·ªôp h·ªì s∆°" required></div>
          <div><input type="text" name="MST" pattern="[0-9]+" id="MST" placeholder="MST"></div>
          <div><input type="text" name="hoTen" id="hoTen" placeholder="C√°n b·ªô ph·ª• tr√°ch" required></div>
          <div><input type="tel" name="sdt" id="sdt" placeholder="S·ªë ƒëi·ªán tho·∫°i" required></div>
          <div class="full"><input type="email" name="email" id="email" placeholder="Email" required></div>
          
          <div class="full">
            <select name="lev1" id="lev1" required>
              <option value="">Ch·ªçn g√≥i th·∫ßu</option>
              <option value="G78A">01. G7.8A-LTIA</option>
              <option value="G78">02. G7.8-LTIA</option>
            </select>
          </div>

          <div class="full" style="display: none;">
            <select name="lev2" id="lev2">
              <option value="">Ch·ªçn t·ªïng th·∫ßu</option>
              <option value="L2TM1" data-lev1="G78A G78">CHUNG LI√äN DANH</option>
              <option value="L2TM2" data-lev1="G78A G78">HANCORP</option>
              <option value="L2TM3" data-lev1="G78A G78">ATAD</option>
              <option value="L2TM4" data-lev1="G78A">PVC-MS</option>
              <option value="L2TM5" data-lev1="G78">COTECCONS</option>
            </select>
          </div>

          <div class="full" style="display: none;">
            <select name="lev3" id="lev3">
              <option value="">Ch·ªçn th∆∞ m·ª•c HS c·∫•p 1</option>
              <option value="L3TM1" data-lev2="L2TM1 L2TM2 L2TM3 L2TM4 L2TM5 L2TM6">00. H·ªì s∆° Ph√°p l√Ω</option>
              <option value="L3TM2" data-lev2="L2TM1 L2TM2 L2TM3 L2TM4 L2TM5 L2TM6">01. B·∫£n v·∫Ω TKKT (B2)</option>
              <option value="L3TM3" data-lev2="L2TM1 L2TM2 L2TM3 L2TM4 L2TM5 L2TM6">02. B·∫£n v·∫Ω TKTC (B3)</option>
              <option value="L3TM4" data-lev2="L2TM1 L2TM2 L2TM3 L2TM4 L2TM5 L2TM6">03. H·ªì s∆° KCS</option>
              <option value="L3TM5" data-lev2="L2TM1 L2TM2 L2TM3 L2TM4 L2TM5 L2TM6">04. T·∫°m ·ª©ng v·∫≠t t∆∞</option>
              <option value="L3TM6" data-lev2="L2TM1 L2TM2 L2TM3 L2TM4 L2TM5 L2TM6">05. H·ªì s∆° Thanh to√°n</option>
              <option value="L3TM7" data-lev2="L2TM1 L2TM2 L2TM3 L2TM4 L2TM5 L2TM6">06. H·ªì s∆° Quy·∫øt to√°n</option>
            </select>
          </div>

          <div class="full" style="display: none;">
            <select name="lev4" id="lev4">
              <option value="">Ch·ªçn th∆∞ m·ª•c HS c·∫•p 2</option>
              <option value="L4TM1" data-lev3="L3TM1 L3TM2 L3TM3 L3TM4 L3TM5 L3TM6 L3TM7">01. File m·ªÅm</option>
              <option value="L4TM2" data-lev3="L3TM1 L3TM2 L3TM3 L3TM4 L3TM5 L3TM6 L3TM7">02. File scan</option>
              <option value="L4TM3" data-lev3="L3TM7">B·∫£n v·∫Ω Ho√†n C√¥ng</option>
              <option value="L4TM4" data-lev3="L3TM6 L3TM7">DGKL b·∫£n Scan</option>
            </select>
          </div>

          <div class="full" style="display: none;">
            <select name="lev5" id="lev5">
              <option value="">Ch·ªçn th∆∞ m·ª•c HS c·∫•p 3</option>
              <option value="L5TM1" data-lev4="L4TM1 L4TM2 L4TM3 L4TM4">01.</option>
              <option value="L5TM2" data-lev4="L4TM1 L4TM2 L4TM3 L4TM4">02.</option>
              <option value="L5TM3" data-lev4="L4TM1 L4TM2 L4TM3 L4TM4">03.</option>
              <option value="L5TM4" data-lev4="L4TM1 L4TM2 L4TM3 L4TM4">04.</option>
            </select>
          </div>

          <div class="full">
            <div id="dropZone" class="drop-zone">
              <p class="drop-zone-text"><svg class="drop-zone-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
              </svg><br>
              K√©o th·∫£ file v√†o ƒë√¢y ho·∫∑c nh·∫•n ƒë·ªÉ ch·ªçn</p>
            </div>

            <div class="button-zone">
              <button type="button" id="selectFilesBtn" class="select-files-btn">üìÅ Ch·ªçn Files</button>
              <button type="button" id="selectFoldersBtn" class="select-folders-btn">üìÇ Ch·ªçn Folder</button>
              <input type="password" name="password" id="password" placeholder="M·∫≠t kh·∫©u chung" required>
            </div>
          </div>

          <input type="file" id="fileInput" multiple style="display: none;">
          <input type="file" id="folderInput" webkitdirectory multiple style="display: none;">

<div class="full" id="selectedFilesContainerWrapper" style="display: none;">
  <h4 class="selected-files-header">File ƒë√£ ch·ªçn</h4>
  <div id="filesList" class="files-list"></div>
  <div class="files-list-container">
    <span id="filesCount" class="files-count"></span>
    <button type="button" id="clearAllBtn" class="clear-all-btn">X√≥a t·∫•t c·∫£</button>
  </div>
</div>

          <!--p class="g-recaptcha" data-sitekey="6LdnuukmAAAAADonaDnbQH9p9SJwEQ8vLtiJYU5H"></p-->

          <div class="full">
            <button type="submit" class="submit" id="submitBtn">N·ªôp b√†i</button>
            <button type="button" class="reset" id="resetBtn">Reset</button>
          </div>
        </form>

        <form id="formUpload" style="display: none;" enctype="multipart/form-data">
          <input type="file" name="myFile" id="upload_myFile">
          <input type="hidden" name="folderId" id="upload_folderId">
          <input type="hidden" name="folderPath" id="upload_folderPath">
          <input type="hidden" name="fileName" id="upload_fileName">
          <input type="hidden" name="relativePath" id="upload_relativePath">
        </form>

        <p class="note">L∆∞u √Ω:
          <br>- K√≠ch th∆∞·ªõc file kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 45MB;
          <br>- Kh√¥ng th·ªÉ b·∫•m HU·ª∂ n·∫øu qu√° tr√¨nh upload ƒë√£ b·∫Øt ƒë·∫ßu;
          <br>- Tr∆∞·ªùng h·ª£p upload sai üëâ li√™n h·ªá Mr. Ti·∫øn ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£.</p>
      </div>
	  
      <div class="about-company">
        <h3>About Us</h3>
        <p></p>
        <div class="about">
          T·ªïng C√¥ng ty X√¢y d·ª±ng H√† N·ªôi l√† m·ªôt t·ªï ch·ª©c x√¢y d·ª±ng ti√™n phong, cam k·∫øt mang ƒë·∫øn m√¥i tr∆∞·ªùng s√°ng t·∫°o v√† hi·ªáu qu·∫£ cho c√¥ng nh√¢n.
        </div>
      </div>
      <div class="contact-info">
        <h3>Contact Us</h3>
        <p></p>
        <div class="contact">
          <table>
            <tbody>
              <tr>
                <td style="vertical-align:top; text-align: center;"><i class="fa fa-home"></i></td>
                <td rowspan="3" style="width:4.5px"></td>
                <td style="vertical-align:top">C√¥ng ty TNHH DV & GP Vintech</td>
              </tr>
              <tr>
                <td style="vertical-align:top; text-align: center;"><i class="fa fa-id-card-o"></i></td>
                <td style="vertical-align:top">MST: <a href="https://hotroca.com/goto?url=http://online.gov.vn/Home/WebDetails/97212">0402050829</a></td>
              </tr>
              <tr>
                <td style="vertical-align:top; text-align: center;"><i class="fa fa-envelope"></i></td>
                <td style="vertical-align:top"><a href="mailto:cskh@vin-tech.com.vn">cskh@vin-tech.com.vn</a>
                  <br><a href="mailto:feedback@khachhang.hotroca.com">feedback@khachhang.hotroca.com</a></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<form id="formUpload" style="display: none;" enctype="multipart/form-data">
  <input type="file" name="myFile" id="upload_myFile">
  <input type="hidden" name="folderId" id="upload_folderId">
  <input type="hidden" name="folderPath" id="upload_folderPath">
  <input type="hidden" name="fileName" id="upload_fileName">
  <input type="hidden" name="relativePath" id="upload_relativePath">
</form>

  <!-- Modal th√¥ng b√°o -->
  <div id="modal" class="hidden">
    <div class="modal-content">
      <h2 id="modalTitle"></h2>
      <p id="modalMessage"></p>
      <button id="modalClose">ƒê√≥ng</button>
    </div>
  </div>

	<footer>
		<div title="Zalo" id="linkzalo">
			<div id="fcta-zalo-tracking" class="fcta-zalo-mess"><span id="zalo_number">{$phoneNumber}</span></div>
			<div class="fcta-zalo-vi-tri-nut">
				<div id="fcta-zalo-tracking" class="fcta-zalo-nen-nut">
					<div id="fcta-zalo-tracking" class="fcta-zalo-ben-trong-nut">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 460.1 436.6">
							<path fill="currentColor" class="st0" d="M82.6 380.9c-1.8-.8-3.1-1.7-1-3.5 1.3-1 2.7-1.9 4.1-2.8 13.1-8.5 25.4-17.8 33.5-31.5 6.8-11.4 5.7-18.1-2.8-26.5C69 269.2 48.2 212.5 58.6 145.5 64.5 107.7 81.8 75 107 46.6c15.2-17.2 33.3-31.1 53.1-42.7 1.2-.7 2.9-.9 3.1-2.7-.4-1-1.1-.7-1.7-.7-33.7 0-67.4-.7-101 .2C28.3 1.7.5 26.6.6 62.3c.2 104.3 0 208.6 0 313 0 32.4 24.7 59.5 57 60.7 27.3 1.1 54.6.2 82 .1 2 .1 4 .2 6 .2H290c36 0 72 .2 108 0 33.4 0 60.5-27 60.5-60.3v-.6-58.5c0-1.4.5-2.9-.4-4.4-1.8.1-2.5 1.6-3.5 2.6-19.4 19.5-42.3 35.2-67.4 46.3-61.5 27.1-124.1 29-187.6 7.2-5.5-2-11.5-2.2-17.2-.8-8.4 2.1-16.7 4.6-25 7.1-24.4 7.6-49.3 11-74.8 6zm72.5-168.5c1.7-2.2 2.6-3.5 3.6-4.8 13.1-16.6 26.2-33.2 39.3-49.9 3.8-4.8 7.6-9.7 10-15.5 2.8-6.6-.2-12.8-7-15.2-3-.9-6.2-1.3-9.4-1.1-17.8-.1-35.7-.1-53.5 0-2.5 0-5 .3-7.4.9-5.6 1.4-9 7.1-7.6 12.8 1 3.8 4 6.8 7.8 7.7 2.4.6 4.9.9 7.4.8 10.8.1 21.7 0 32.5.1 1.2 0 2.7-.8 3.6 1-.9 1.2-1.8 2.4-2.7 3.5-15.5 19.6-30.9 39.3-46.4 58.9-3.8 4.9-5.8 10.3-3 16.3s8.5 7.1 14.3 7.5c4.6.3 9.3.1 14 .1 16.2 0 32.3.1 48.5-.1 8.6-.1 13.2-5.3 12.3-13.3-.7-6.3-5-9.6-13-9.7-14.1-.1-28.2 0-43.3 0zm116-52.6c-12.5-10.9-26.3-11.6-39.8-3.6-16.4 9.6-22.4 25.3-20.4 43.5 1.9 17 9.3 30.9 27.1 36.6 11.1 3.6 21.4 2.3 30.5-5.1 2.4-1.9 3.1-1.5 4.8.6 3.3 4.2 9 5.8 14 3.9 5-1.5 8.3-6.1 8.3-11.3.1-20 .2-40 0-60-.1-8-7.6-13.1-15.4-11.5-4.3.9-6.7 3.8-9.1 6.9zm69.3 37.1c-.4 25 20.3 43.9 46.3 41.3 23.9-2.4 39.4-20.3 38.6-45.6-.8-25-19.4-42.1-44.9-41.3-23.9.7-40.8 19.9-40 45.6zm-8.8-19.9c0-15.7.1-31.3 0-47 0-8-5.1-13-12.7-12.9-7.4.1-12.3 5.1-12.4 12.8-.1 4.7 0 9.3 0 14v79.5c0 6.2 3.8 11.6 8.8 12.9 6.9 1.9 14-2.2 15.8-9.1.3-1.2.5-2.4.4-3.7.2-15.5.1-31 .1-46.5z"></path>
						</svg>
					</div>
					<div id="fcta-zalo-tracking" class="fcta-zalo-text">Chat ngay</div>
				</div>
			</div>
		</div>
	</footer>

<script>
const phoneNumbers = ['0399.195.123', '0399.195.123'];
let currentIndex = 0;
// Define a map of phone numbers to Zalo links
const zaloLinks = {
	'0399.195.123': '1x0zaq4hh400o',
};

function getNextPhoneNumber() {
	currentIndex = (currentIndex + 1) % phoneNumbers.length;
	return phoneNumbers[currentIndex];
}

function updatePhoneNumber() {
	const phoneNumber = getNextPhoneNumber();
	// Get the Zalo link based on the selected phone number
	const zaloLink = zaloLinks[phoneNumber] || 'default-link'; // Replace 'default-link' with your default link
	// Set the phone number in the HTML
	const phoneNumberElement = document.getElementById('zalo_number');
	phoneNumberElement.textContent = phoneNumber
		// Update the Zalo link code
	const nutzalo = document.getElementById('linkzalo');
	nutzalo.onclick = () => ZaloClick(zaloLink, phoneNumber);
}
// Initial update
updatePhoneNumber();
// Update every 10 seconds
setInterval(updatePhoneNumber, 10000);

function isMobileDevice() {
	return /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
}

function ZaloClick(link, phoneNumber) {
	let zaloLink = 'https://zaloapp.com/qr/p/' + link;
	if(isMobileDevice()) {
		if(navigator.userAgent.includes('Android')) {
			// Android
			zaloLink = 'https://zaloapp.com/qr/p/' + link;
		} else {
			// iOS
			zaloLink = 'zalo://qr/p/' + link;
		}
	} else {
		// Zalo link for PC
		zaloLink = 'zalo://conversation?phone=' + phoneNumber;
	}
	window.open(zaloLink, '_blank');
}
</script>

<script>
// üóÇÔ∏è STATE qu·∫£n l√Ω t·∫≠p trung (tr√°nh bi·∫øn global r·∫£i r√°c)
const state = {
  selectedFiles: [],           // Danh s√°ch file ri√™ng l·∫ª
  selectedFolders: [],          // Danh s√°ch folder (c√≥ c·∫•u tr√∫c)
  cancelRequested: false,       // C·ªù h·ªßy upload
  uploadInterval: null,         // Timer hi·ªÉn th·ªã ti·∫øn tr√¨nh
  latestUploadId: Date.now(),   // ID upload m·ªõi nh·∫•t (tr√°nh race condition)
  storageFields: ['Company', 'MST', 'hoTen', 'email', 'sdt', 'lev1', 'lev2', 'lev3', 'lev4', 'lev5'],
  folderTreeCache: new WeakMap() // Cache c√¢y th∆∞ m·ª•c (t·ªëi ∆∞u render)
};

// üìè C·∫•u h√¨nh
const CONFIG = {
  MAX_FILE_SIZE: 45 * 1024 * 1024 // 45MB
};

// üíæ ƒê·ªìng b·ªô localStorage (load/save)
function syncLocalStorage(mode) {
  state.storageFields.forEach(field => {
    const el = document.getElementById(field);
    if (!el) return;
    
    if (mode === 'load') {
      const value = localStorage.getItem(field);
      if (value !== null) el.value = value;
    } else if (mode === 'save') {
      localStorage.setItem(field, el.value);
    }
  });
}

// ‚úÖ Ki·ªÉm tra k√≠ch th∆∞·ªõc file
function validateFileSize(file) {
  return file.size <= CONFIG.MAX_FILE_SIZE;
}

// üîç L·ªçc file h·ª£p l·ªá v√† c·∫£nh b√°o file qu√° l·ªõn
function filterValidFiles(files) {
  const valid = [];
  const invalid = [];
  
  Array.from(files).forEach(file => {
    if (validateFileSize(file)) {
      valid.push(file);
    } else {
      invalid.push(file.name);
    }
  });
  
  if (invalid.length > 0) {
    showModal('C·∫£nh b√°o', 
      `${invalid.length} file v∆∞·ª£t qu√° 45MB ƒë√£ b·ªã b·ªè qua:\n` +
      `${invalid.slice(0, 3).join('\n')}${invalid.length > 3 ? '\n...' : ''}`, 
      true
    );
  }
  
  return valid;
}

// üì¶ Kh·ªüi t·∫°o khi trang load
document.addEventListener('DOMContentLoaded', () => {
  syncLocalStorage('load');
  updateVisibility();

  // Ki·ªÉm tra tr√¨nh duy·ªát c√≥ h·ªó tr·ª£ upload folder kh√¥ng
  const folderInput = document.getElementById('folderInput');
  if (!folderInput?.webkitdirectory) {
    document.getElementById('selectFoldersBtn').disabled = true;
    showModal('C·∫£nh b√°o', 
      'Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ upload th∆∞ m·ª•c. Ch·ªâ c√≥ th·ªÉ upload file ri√™ng l·∫ª.', 
      true
    );
  }
});

// üì¢ Modal th√¥ng b√°o
function showModal(title, message, isError = false, folderUrl = null) {
  const modal = document.getElementById('modal');
  const modalTitle = document.getElementById('modalTitle');
  const modalMessage = document.getElementById('modalMessage');
  
  modalTitle.innerText = title || 'Th√¥ng b√°o';
  modalTitle.classList.remove('success', 'error');
  modalTitle.classList.add(isError ? 'error' : 'success');
  
  modalMessage.innerHTML = folderUrl
    ? (message || '') + `<br><br><a href="${folderUrl}" target="_blank" style="color: #2563eb;">üîó Truy c·∫≠p th∆∞ m·ª•c</a>`
    : message || '';
    
  modal.classList.remove('hidden');
}

document.getElementById('modalClose').addEventListener('click', () => {
  document.getElementById('modal').classList.add('hidden');
});

// üå≥ X√¢y d·ª±ng c√¢y th∆∞ m·ª•c t·ª´ webkitRelativePath
function buildFolderTree(files) {
  const root = { name: '', files: [], folders: {} };
  
  files.forEach(file => {
    if (!file.webkitRelativePath) {
      root.files.push(file);
      return;
    }
    
    const pathParts = file.webkitRelativePath.split('/').slice(0, -1);
    let current = root;
    
    pathParts.forEach((part, index) => {
      if (!current.folders[part]) {
        current.folders[part] = { name: part, files: [], folders: {} };
      }
      current = current.folders[part];
      
      if (index === pathParts.length - 1) {
        current.files.push(file);
      }
    });
  });
  
  return root;
}

// üóÑÔ∏è L·∫•y c√¢y th∆∞ m·ª•c v·ªõi cache
function getFolderTree(folder) {
  if (!state.folderTreeCache.has(folder)) {
    state.folderTreeCache.set(folder, buildFolderTree(folder.files || []));
  }
  return state.folderTreeCache.get(folder);
}

// üî¢ ƒê·∫øm t·ªïng file trong c√¢y
function countFilesInTree(node) {
  return node.files.length + 
    Object.values(node.folders).reduce((sum, f) => sum + countFilesInTree(f), 0);
}

// üé® Render c√¢y th∆∞ m·ª•c (d√πng DocumentFragment t·ªëi ∆∞u DOM)
function renderFolderTree(node, parentElement, folderPath = [], folderIndex = null) {
  const fragment = document.createDocumentFragment();

  // Render files
  node.files.forEach((file, fileIndex) => {
    const fileItem = document.createElement('div');
    fileItem.className = 'file-upload-item';
    fileItem.innerHTML = `
      <div class="file-upload-info">
        <span class="file-upload-icon-blue">üìÑ</span>
        <span class="file-upload-name">${file.name}</span>
        <span class="file-upload-size">(${(file.size / 1024).toFixed(2)} KB)</span>
      </div>
      <button type="button" class="file-upload-remove-btn" 
              onclick="removeFileFromFolder(${folderIndex}, ${JSON.stringify(folderPath)}, ${fileIndex})">√ó</button>
    `;
    fragment.appendChild(fileItem);
  });

  // Render subfolders
  Object.values(node.folders).forEach((folder, subFolderIndex) => {
    const folderItem = document.createElement('div');
    folderItem.className = 'file-upload-item file-upload-folder';
    const fileCount = countFilesInTree(folder);
    
    folderItem.innerHTML = `
      <div class="file-upload-folder-header">
        <div class="file-upload-info">
          <span class="file-upload-icon-green">üìÇ</span>
          <span class="file-upload-name">${folder.name}</span>
          <span class="file-upload-size">(${fileCount} files)</span>
        </div>
        <button type="button" class="file-upload-remove-btn" 
                onclick="removeFolder(${folderIndex}, ${JSON.stringify(folderPath)}, ${subFolderIndex})">√ó</button>
      </div>
    `;
    
    const filesContainer = document.createElement('div');
    filesContainer.className = 'file-upload-tree';
    folderItem.appendChild(filesContainer);
    fragment.appendChild(folderItem);
    
    renderFolderTree(folder, filesContainer, [...folderPath, subFolderIndex], folderIndex);
  });

  parentElement.appendChild(fragment);
}

// üîÑ C·∫≠p nh·∫≠t danh s√°ch file hi·ªÉn th·ªã
function updateFilesList() {
  const container = document.getElementById('selectedFilesContainerWrapper');
  const filesList = document.getElementById('filesList');
  const filesCount = document.getElementById('filesCount');

  // T√≠nh t·ªïng file
  let totalFiles = state.selectedFiles.length;
  state.selectedFolders.forEach(folder => {
    totalFiles += countFilesInTree(getFolderTree(folder));
  });

  if (totalFiles === 0) {
    container.style.display = 'none';
    filesList.innerHTML = '';
    filesCount.textContent = '';
    return;
  }

  container.style.display = 'block';
  const fragment = document.createDocumentFragment();

  // Render file ri√™ng l·∫ª
  state.selectedFiles.forEach((file, index) => {
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    fileItem.innerHTML = `
      <div class="file-info">
        <span class="file-icon">üìÑ</span>
        <span class="file-name">${file.name}</span>
        <span class="file-size">(${(file.size / 1024).toFixed(2)} KB)</span>
      </div>
      <button type="button" class="remove-btn" onclick="removeFile(${index})">√ó</button>
    `;
    fragment.appendChild(fileItem);
  });

  // Render folders
  state.selectedFolders.forEach((folder, folderIndex) => {
    const folderTree = getFolderTree(folder);
    const fileCount = countFilesInTree(folderTree);
    
    const folderContainer = document.createElement('div');
    folderContainer.className = 'file-upload-item file-upload-folder';
    folderContainer.innerHTML = `
      <div class="file-upload-folder-header">
        <div class="file-upload-info">
          <span class="file-upload-icon-green">üìÇ</span>
          <span class="file-upload-name">${folder.name}</span>
          <span class="file-upload-size">(${fileCount} files)</span>
        </div>
        <button type="button" class="file-upload-remove-btn" 
                onclick="removeFolder(${folderIndex}, null, null)">√ó</button>
      </div>
    `;
    
    const filesContainer = document.createElement('div');
    filesContainer.className = 'file-upload-tree';
    folderContainer.appendChild(filesContainer);
    fragment.appendChild(folderContainer);
    
    renderFolderTree(folderTree, filesContainer, [], folderIndex);
  });

  filesList.innerHTML = '';
  filesList.appendChild(fragment);
  filesCount.textContent = `T·ªïng: ${totalFiles} file${totalFiles > 1 ? 's' : ''}`;
}

// üóëÔ∏è X√≥a file ri√™ng l·∫ª
function removeFile(index) {
  state.selectedFiles.splice(index, 1);
  updateFilesList();
}

// üóëÔ∏è X√≥a folder ho·∫∑c subfolder
function removeFolder(folderIndex, folderPath, subFolderIndex) {
  if (folderPath === null && subFolderIndex === null) {
    state.selectedFolders.splice(folderIndex, 1);
  } else {
    const folder = state.selectedFolders[folderIndex];
    const tree = getFolderTree(folder);
    
    let current = tree;
    folderPath.forEach(pathIndex => {
      current = Object.values(current.folders)[pathIndex];
    });
    
    const subFolderName = Object.keys(current.folders)[subFolderIndex];
    const subFolderToRemove = current.folders[subFolderName];
    
    if (subFolderToRemove) {
      const filesToRemove = flattenFolderTree(subFolderToRemove);
      folder.files = folder.files.filter(file => !filesToRemove.includes(file));
      state.folderTreeCache.delete(folder);
    }
  }
  updateFilesList();
}

// üóëÔ∏è X√≥a file trong folder
function removeFileFromFolder(folderIndex, folderPath, fileIndex) {
  const folder = state.selectedFolders[folderIndex];
  const tree = getFolderTree(folder);
  
  let targetFiles;
  if (folderPath.length === 0) {
    targetFiles = tree.files;
  } else {
    let current = tree;
    folderPath.forEach(pathIndex => {
      current = Object.values(current.folders)[pathIndex];
    });
    targetFiles = current.files;
  }
  
  const fileToRemove = targetFiles[fileIndex];
  if (!fileToRemove) return;
  
  folder.files = folder.files.filter(file => file !== fileToRemove);
  state.folderTreeCache.delete(folder);
  updateFilesList();
}

// üå≥ Flatten tree th√†nh m·∫£ng file
function flattenFolderTree(node) {
  let files = [...node.files];
  Object.values(node.folders).forEach(folder => {
    files = files.concat(flattenFolderTree(folder));
  });
  return files;
}

// üñ±Ô∏è Drag & Drop
const dropZone = document.getElementById('dropZone');

dropZone.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropZone.classList.add('dragover');
});

dropZone.addEventListener('dragleave', (e) => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
});

dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  processDroppedFiles(e.dataTransfer.files);
});

dropZone.addEventListener('click', () => {
  document.getElementById('fileInput').click();
});

// üìÇ X·ª≠ l√Ω file dropped/selected
function processDroppedFiles(files) {
  const validFiles = filterValidFiles(files);
  const folderMap = {};
  
  validFiles.forEach(file => {
    if (file.webkitRelativePath) {
      const folderName = file.webkitRelativePath.split('/')[0];
      if (!folderMap[folderName]) {
        folderMap[folderName] = { name: folderName, files: [] };
      }
      folderMap[folderName].files.push(file);
    } else {
      state.selectedFiles.push(file);
    }
  });
  
  Object.values(folderMap).forEach(folder => {
    state.selectedFolders.push(folder);
  });
  
  updateFilesList();
}

// üîò Ch·ªçn files
document.getElementById('selectFilesBtn').addEventListener('click', () => {
  document.getElementById('fileInput').click();
});

document.getElementById('fileInput').addEventListener('change', (e) => {
  processDroppedFiles(e.target.files);
  e.target.value = '';
});

// üîò Ch·ªçn folder
document.getElementById('selectFoldersBtn').addEventListener('click', () => {
  document.getElementById('folderInput').click();
});

document.getElementById('folderInput').addEventListener('change', (e) => {
  const files = Array.from(e.target.files);
  if (!files[0]?.webkitRelativePath && files.length > 0) {
    showModal('L·ªói', 
      'Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ upload th∆∞ m·ª•c. Vui l√≤ng s·ª≠ d·ª•ng Chrome ho·∫∑c Edge.', 
      true
    );
    return;
  }
  processDroppedFiles(e.target.files);
  e.target.value = '';
});

// üóëÔ∏è X√≥a t·∫•t c·∫£
document.getElementById('clearAllBtn').addEventListener('click', () => {
  state.selectedFiles = [];
  state.selectedFolders = [];
  updateFilesList();
});

// üî¥ Reset/H·ªßy
document.getElementById('resetBtn').addEventListener('click', function () {
  const form = document.getElementById('myForm');
  const formUpload = document.getElementById('formUpload');
  const submitBtn = document.getElementById('submitBtn');

  if (this.innerText === 'H·ªßy') {
    // H·ªßy upload ƒëang ch·∫°y
    state.cancelRequested = true;
    state.latestUploadId = Date.now();
    clearInterval(state.uploadInterval);

    submitBtn.innerText = 'N·ªôp b√†i';
    submitBtn.disabled = false;
    this.innerText = 'Reset';
    this.disabled = false;

    formUpload.reset();
    return;
  }

  // Reset to√†n b·ªô
  form.reset();
  formUpload.reset();
  state.selectedFiles = [];
  state.selectedFolders = [];
  updateFilesList();
  localStorage.clear();
  state.cancelRequested = false;
  updateVisibility();
});

// üì§ SUBMIT FORM - T∆Ø∆†NG TH√çCH 100% V·ªöI CODE.GS
document.getElementById('myForm').addEventListener('submit', async function (e) {
  e.preventDefault();
  const form = this;
  const submitBtn = document.getElementById('submitBtn');
  const resetBtn = document.getElementById('resetBtn');

  submitBtn.innerText = 'ƒêang x·ª≠ l√Ω...';
  submitBtn.disabled = true;
  resetBtn.innerText = 'H·ªßy';
  resetBtn.disabled = false;
  state.cancelRequested = false;

  const currentUploadId = Date.now();
  state.latestUploadId = currentUploadId;

  // üìã Thu th·∫≠p d·ªØ li·ªáu form
  const prepareData = {
    password: form.password.value,
    Company: form.Company.value,
    MST: form.MST.value,
    hoTen: form.hoTen.value,
    email: form.email.value,
    sdt: form.sdt.value,
    lev1_text: form.lev1.value ? form.lev1.options[form.lev1.selectedIndex].text : '',
    lev2_text: form.lev2.value ? form.lev2.options[form.lev2.selectedIndex].text : '',
    lev3_text: form.lev3.value ? form.lev3.options[form.lev3.selectedIndex].text : '',
    lev4_text: form.lev4.value ? form.lev4.options[form.lev4.selectedIndex].text : '',
    lev5_text: form.lev5.value ? form.lev5.options[form.lev5.selectedIndex].text : '',
    folderStructures: []
  };

  const allFiles = [...state.selectedFiles];
  state.selectedFolders.forEach(folder => {
    allFiles.push(...folder.files);
  });

  // üìÇ Thu th·∫≠p c·∫•u tr√∫c th∆∞ m·ª•c con
  allFiles.forEach(file => {
    if (file.webkitRelativePath) {
      const pathParts = file.webkitRelativePath.split('/').slice(0, -1);
      if (pathParts.length > 0) {
        prepareData.folderStructures.push(pathParts);
      }
    }
  });

  try {
    // üü° TI·∫æN TR√åNH 1: Chu·∫©n b·ªã th∆∞ m·ª•c
    const prepResult = await new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .prepareUpload(prepareData);
    });

    if (state.cancelRequested || currentUploadId !== state.latestUploadId) {
      submitBtn.innerText = 'N·ªôp b√†i';
      submitBtn.disabled = false;
      resetBtn.innerText = 'Reset';
      resetBtn.disabled = false;
      return;
    }

    if (prepResult.status !== 'ready') {
      showModal('L·ªói', prepResult.message, true);
      submitBtn.innerText = 'N·ªôp b√†i';
      submitBtn.disabled = false;
      resetBtn.innerText = 'Reset';
      resetBtn.disabled = false;
      return;
    }

    // Kh√≥a n√∫t Reset khi b·∫Øt ƒë·∫ßu upload file
    resetBtn.innerText = 'Reset';
    resetBtn.disabled = true;

    const formUpload = document.getElementById('formUpload');
    const fileInput = document.getElementById('upload_myFile');
    const folderInput = document.getElementById('upload_folderId');
    const pathInput = document.getElementById('upload_folderPath');
    const fileNameInput = document.getElementById('upload_fileName');
    const relativePathInput = document.getElementById('upload_relativePath');

    folderInput.value = prepResult.folderId;
    pathInput.value = prepResult.folderPath;

    // ‚è±Ô∏è Theo d√µi ti·∫øn tr√¨nh
    let uploadedFiles = 0;
    const errors = [];
    const startTime = Date.now();
    
    state.uploadInterval = setInterval(() => {
      const seconds = Math.floor((Date.now() - startTime) / 1000);
      submitBtn.innerText = `ƒêang t·∫£i l√™n: ${uploadedFiles}/${allFiles.length} (${seconds}s)`;
    }, 1000);

    // üü¢ TI·∫æN TR√åNH 2: Upload t·ª´ng file
    for (const file of allFiles) {
      if (state.cancelRequested || currentUploadId !== state.latestUploadId) {
        clearInterval(state.uploadInterval);
        submitBtn.innerText = 'N·ªôp b√†i';
        submitBtn.disabled = false;
        resetBtn.innerText = 'Reset';
        resetBtn.disabled = false;
        return;
      }

      // ‚úÖ FIX: T·∫°o plain object thay v√¨ truy·ªÅn form element

      fileInput.files = createFileList(file);
      fileNameInput.value = file.name;
      relativePathInput.value = file.webkitRelativePath || '';

      try {
        const result = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .uploadFileWithFolder(formUpload);
        });

        if (result.status === 'success') {
          uploadedFiles++;
        } else {
          errors.push(result.message);
        }
      } catch (error) {
        errors.push(`File ${file.name}: ${error.message || error}`);
      }
    }

    clearInterval(state.uploadInterval);
    submitBtn.innerText = 'N·ªôp b√†i';
    submitBtn.disabled = false;
    resetBtn.innerText = 'Reset';
    resetBtn.disabled = false;

    // üì¢ Hi·ªÉn th·ªã k·∫øt qu·∫£
    if (uploadedFiles === 0) {
      showModal('L·ªói', 
        `Kh√¥ng c√≥ file n√†o ƒë∆∞·ª£c upload th√†nh c√¥ng.\nL·ªói: ${errors.join('\n')}`, 
        true
      );
      return;
    }

    showModal(
      uploadedFiles < allFiles.length ? 'Ho√†n th√†nh m·ªôt ph·∫ßn' : 'Th√†nh c√¥ng',
      `ƒê√£ upload ${uploadedFiles}/${allFiles.length} file v√†o th∆∞ m·ª•c: ${prepResult.folderPath}` +
      (errors.length > 0 ? `\nL·ªói: ${errors.join('\n')}` : ''),
      uploadedFiles < allFiles.length,
      prepResult.folderUrl
    );

    // ‚úÖ L∆∞u form data v√† clear files n·∫øu th√†nh c√¥ng ho√†n to√†n
    if (uploadedFiles === allFiles.length) {
      syncLocalStorage('save');
      state.selectedFiles = [];
      state.selectedFolders = [];
      updateFilesList();
    }
  } catch (error) {
    clearInterval(state.uploadInterval);
    showModal('L·ªói', `L·ªói h·ªá th·ªëng: ${error.message || error}`, true);
    submitBtn.innerText = 'N·ªôp b√†i';
    submitBtn.disabled = false;
    resetBtn.innerText = 'Reset';
    resetBtn.disabled = false;
  }
});

// üõ†Ô∏è Helper: T·∫°o FileList t·ª´ single file
function createFileList(file) {
  const dt = new DataTransfer();
  dt.items.add(file);
  return dt.files;
}

// ============================================
// CASCADING SELECT (GI·ªÆ NGUY√äN T·ª™ FORM G·ªêC)
// ============================================

document.addEventListener("DOMContentLoaded", function () {
  const lev1 = document.getElementById("lev1");
  const lev2 = document.getElementById("lev2");
  const lev3 = document.getElementById("lev3");
  const lev4 = document.getElementById("lev4");
  const lev5 = document.getElementById("lev5");

  function resetAndHide(select) {
    select.value = "";
    select.parentElement.style.display = "none";
  }

  function show(select) {
    select.parentElement.style.display = "block";
  }

  function filterOptions(select, attribute, value) {
    const options = Array.from(select.options);
    let hasVisibleOptions = false;

    options.forEach(opt => {
      if (opt.value === "") {
        opt.style.display = "";
        opt.hidden = false;
      } else {
        const attrValue = opt.getAttribute(attribute);
        if (attrValue && attrValue.split(" ").includes(value)) {
          opt.style.display = "";
          opt.hidden = false;
          hasVisibleOptions = true;
        } else {
          opt.style.display = "none";
          opt.hidden = true;
        }
      }
    });

    if (select.value !== "" && options.find(opt => opt.value === select.value && opt.hidden)) {
      select.value = "";
    }

    return hasVisibleOptions;
  }

  window.updateVisibility = function() {
    if (lev1.value === "") {
      resetAndHide(lev2);
      resetAndHide(lev3);
      resetAndHide(lev4);
      resetAndHide(lev5);
    } else {
      show(lev2);
      filterOptions(lev2, "data-lev1", lev1.value);

      if (lev2.value === "") {
        resetAndHide(lev3);
        resetAndHide(lev4);
        resetAndHide(lev5);
      } else {
        show(lev3);
        filterOptions(lev3, "data-lev2", lev2.value);

        if (lev3.value === "") {
          resetAndHide(lev4);
          resetAndHide(lev5);
        } else {
          show(lev4);
          filterOptions(lev4, "data-lev3", lev3.value);

          if (lev4.value === "") {
            resetAndHide(lev5);
          } else {
            show(lev5);
            filterOptions(lev5, "data-lev4", lev4.value);
          }
        }
      }
    }
  }

  lev1.addEventListener("change", () => {
    lev2.value = "";
    lev3.value = "";
    lev4.value = "";
    lev5.value = "";
    updateVisibility();
  });

  lev2.addEventListener("change", () => {
    lev3.value = "";
    lev4.value = "";
    lev5.value = "";
    updateVisibility();
  });

  lev3.addEventListener("change", () => {
    lev4.value = "";
    lev5.value = "";
    updateVisibility();
  });

  lev4.addEventListener("change", () => {
    lev5.value = "";
    updateVisibility();
  });

  updateVisibility();
});

// ============================================
// SIDEBAR & CONTAINER SCALING (GI·ªÆ NGUY√äN)
// ============================================

document.addEventListener('DOMContentLoaded', () => {
  const wrapper = document.querySelector('.wrapper');
  const about = document.querySelector('.about-company');
  const info = document.querySelector('.contact-info');

  function checkSidebars() {
    const aboutHidden = !about || getComputedStyle(about).display === 'none';
    const infoHidden = !info || getComputedStyle(info).display === 'none';
    wrapper?.classList.toggle('no-sidebar', aboutHidden && infoHidden);
  }

  checkSidebars();

  const observer = new MutationObserver(checkSidebars);
  if (about) observer.observe(about, { attributes: true, attributeFilter: ['style', 'class'] });
  if (info) observer.observe(info, { attributes: true, attributeFilter: ['style', 'class'] });

  window.addEventListener('resize', () => {
    adjustContainerScale();
    checkSidebars();
  });
});

let fixedScale = null;

function adjustContainerScale() {
  const container = document.querySelector('.container');
  if (!container) return;

  if (window.innerWidth <= 640) {
    container.style.transformOrigin = 'center top';
    container.style.transform = 'scale(0.96)';
    return;
  }

  if (fixedScale !== null) {
    container.style.transformOrigin = '50% 0%';
    container.style.transform = `scale(${fixedScale})`;
    const scaledHeight = container.offsetHeight * fixedScale;
    const topMargin = Math.max(0, (window.innerHeight - scaledHeight) / 2);
    container.style.marginTop = `${topMargin}px`;
    return;
  }

  requestAnimationFrame(() => {
    const naturalHeight = container.scrollHeight || container.offsetHeight;
    const scaleH = window.innerHeight * 0.96 / naturalHeight;
    fixedScale = Math.min(1, Math.max(0.6, scaleH));
    container.style.transformOrigin = '50% 0%';
    container.style.transform = `scale(${fixedScale})`;
    const scaledHeight = naturalHeight * fixedScale;
    const topMargin = Math.max(0, (window.innerHeight - scaledHeight) / 2);
    container.style.marginTop = `${topMargin}px`;
  });
}

window.addEventListener('load', adjustContainerScale);
window.addEventListener('resize', adjustContainerScale);
window.addEventListener('DOMContentLoaded', adjustContainerScale);
</script>

</body>
</html>